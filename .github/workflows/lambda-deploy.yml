name: Deploy Lambda
# GitHub Actions から OIDC で AWS に認証し、
# backend をビルド → ZIP を S3 にアップロード → Lambda を S3 から更新します。

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write   # OIDC用
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
  LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  # 注意: Secrets はリポジトリ Settings → Secrets and variables → Actions に設定します。

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # Lambda のランタイム（nodejs22.x）と合わせることで互換性を担保します。

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
        # GitHub OIDC トークンで指定ロールを Assume し、短期認証を取得します。

      - name: Install all deps and build
        working-directory: backend
        run: |
          # 型定義(@types/*)やTypeScriptはdevDependenciesのため、ビルド時は全てインストール
          npm ci
          npm run build
        # ビルド（tsc）に devDependencies が必須のため、ここでは省略しません。

      - name: "Prepare Lambda artifact (ESM bundle: no node_modules)"
        working-directory: backend
        run: |
          mkdir -p bundle
          cp package.json bundle/
          cp -r dist bundle/dist
          cd bundle
          # ZIP ルートに package.json / dist（esbuild バンドル済み）を配置
          zip -r ../bundle.zip .
        # 重要: ESM 認識のため ZIP ルートに package.json（type: "module"）を含めます。
        # esbuild で依存をバンドルするため node_modules の同梱は不要です。

      - name: Validate S3 bucket env
        run: |
          if [ -z "${{ env.S3_BUCKET }}" ]; then echo "S3_BUCKET is required" && exit 1; fi
        # このワークフローは S3 経由デプロイ専用です。未設定なら失敗させます。

      - name: Set artifact key
        run: |
          echo "ARTIFACT_KEY=lambda/clothes-app-backend/${{ env.LAMBDA_FUNCTION_NAME }}/${{ github.sha }}.zip" >> $GITHUB_ENV
        # 関数名/コミットSHAでキーを構成し、バージョン管理とロールバックを容易にします。

      - name: Inspect bundle (sanity)
        run: |
          unzip -l backend/bundle.zip | sed -n '1,200p'
        # ZIP に package.json / dist/handlers/express.js が含まれているか簡易検査します。

      - name: Upload artifact to S3
        run: |
          aws s3 cp backend/bundle.zip s3://${{ env.S3_BUCKET }}/${{ env.ARTIFACT_KEY }}
        # OIDC ロールには対象バケットへの PutObject/GetObject 権限が必要です。

      - name: Update Lambda code from S3
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --s3-key ${{ env.ARTIFACT_KEY }}
        # Lambda のコードを S3 アーティファクトから更新します（非同期に適用されます）。

      - name: Wait for Lambda code update to complete
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
        # 直後の設定更新で競合しないよう、完了まで待機します（ResourceConflictException対策）。

      - name: Ensure handler/runtime configuration (idempotent)
        run: |
          aws lambda update-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --runtime nodejs22.x \
            --handler dist/handlers/express.handler
        # 念のためランタイム/ハンドラーを明示し、設定のズレを防ぎます。
