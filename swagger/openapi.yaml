openapi: 3.0.3
info:
  title: Clothing Recommendation API
  version: 1.0.0

servers:
  - url: http://localhost:3000  # 後でAPI Gatewayローカルやモックに合わせる

paths:
  /api/profile:
    post:
      summary: Save user profile
      description: プロフィールの新規作成。サーバ側で `userId` を生成します。
      tags: [Profile]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                region:
                  type: string
                birthday:
                  type: string
                  pattern: '^\\d{4}/\\d{2}/\\d{2}$'
                gender:
                  type: string
                  enum: [male, female, other]
                notificationsEnabled:
                  type: boolean
                nickname:
                  type: string
                  maxLength: 30
                family:
                  type: array
                  description: Optional family members (up to 10)
                  maxItems: 10
                  items:
                    type: object
                    required: [name, birthday, gender]
                    properties:
                      name:
                        type: string
                      birthday:
                        type: string
                        pattern: '^\\d{4}/\\d{2}/\\d{2}$'
                      gender:
                        type: string
                        enum: [male, female, other]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  userId:
                    type: string
              examples:
                success:
                  value:
                    message: Profile saved
                    userId: 123e4567-e89b-12d3-a456-426614174000
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  value:
                    error: "Invalid request"
                    details:
                      birthday:
                        - code: "invalid_format"
                          message: "Expected YYYY/MM/DD"
                      nickname:
                        - code: "too_long"
                          message: "Max length is 30"
        "500":
          description: Internal Server Error — 接続エラーや想定外のエラー時
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/profile/{userId}:
    get:
      summary: Get user profile
      tags: [Profile]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                type: object
                required: [userId, region,  birthday, notificationsEnabled, family]
                properties:
                  userId:
                    type: string
                  region:
                    type: string
                  birthday:
                    type: string
                    pattern: '^\\d{4}/\\d{2}/\\d{2}$'
                  gender:
                    type: string
                    enum: [male, female, other]
                  notificationsEnabled:
                    type: boolean
                  nickname:
                    type: string
                    maxLength: 30
                  family:
                    type: array
                    items:
                      type: object
                      required: [name, birthday, gender]
                      properties:
                        name:
                          type: string
                        birthday:
                          type: string
                          pattern: '^\\d{4}/\\d{2}/\\d{2}$'
                        gender:
                          type: string
                          enum: [male, female, other]
              examples:
                success:
                  value:
                    userId: 123e4567-e89b-12d3-a456-426614174000
                    region: "東京"
                    birthday: "2020/04/12"
                    gender: "other"
                    notificationsEnabled: true
                    nickname: "たろう"
                    family:
                      - name: "娘"
                        birthday: "2023/11/01"
                        gender: "female"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  value:
                    error: "Invalid request"
                    details:
                      userId:
                        - code: "required"
                          message: "Required path parameter"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  value:
                    error: "Not Found"
        "500":
          description: Internal Server Error — 接続エラーや想定外のエラー時
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Update user profile (partial)
      description: Send only fields you want to change. Unspecified fields remain unchanged. At least one field must be provided.
      tags: [Profile]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              minProperties: 1
              properties:
                region:
                  type: string
                birthday:
                  type: string
                  pattern: '^\\d{4}/\\d{2}/\\d{2}$'
                gender:
                  type: string
                  enum: [male, female, other]
                notificationsEnabled:
                  type: boolean
                nickname:
                  type: string
                  maxLength: 30
                family:
                  type: array
                  description: Optional family members (up to 10)
                  maxItems: 10
                  items:
                    type: object
                    required: [name, birthday, gender]
                    properties:
                      name:
                        type: string
                      birthday:
                        type: string
                        pattern: '^\\d{4}/\\d{2}/\\d{2}$'
                      gender:
                        type: string
                        enum: [male, female, other]
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  userId:
                    type: string
              examples:
                success:
                  value:
                    message: "Profile updated"
                    userId: 123e4567-e89b-12d3-a456-426614174000
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  value:
                    error: "Invalid request"
                    details:
                      nickname:
                        - code: "too_long"
                          message: "Max length is 30"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  value:
                    error: "Not Found"
        "500":
          description: Internal Server Error — 接続エラーや想定外のエラー時
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/home/{userId}:
    get:
      summary: Get today's combined home data
      description: ホーム画面用の統合API。天気情報、今日のひとこと、本日の服装を一括で返す。
      tags: [Home]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HomeTodayResponse'
              examples:
                success:
                  value:
                    summary: "薄手の長袖と軽めの羽織りがちょうど良い気温です。風が強い場合は上着で体温調節を。"
                    weather:
                      region: "船橋"
                      value: 9.0
                      feelsLike: 9.0
                      humidity: 90
                      windSpeed: 1.2
                      category: "cold"
                      condition: "cloudy"
                    members:
                      - name: "たろう"
                        ageGroup: "child"
                        suggestion:
                          summary: "半袖＋薄手羽織で快適（たろう向け）"
                          layers: ["半袖Tシャツ", "薄手パーカー", "動きやすいパンツ"]
                          layersDetailed:
                            - { slot: "top_base", category: "tee_short", displayName: "半袖Tシャツ" }
                            - { slot: "outerwear", category: "hoodie", displayName: "薄手パーカー" }
                            - { slot: "bottom", category: "pants", displayName: "動きやすいパンツ" }
                          notes: []
                      - name: "パパ"
                        ageGroup: "adult"
                        suggestion:
                          summary: "長袖＋軽めの羽織"
                          layers: ["長袖Tシャツ", "薄手パーカー", "パンツ"]
                          layersDetailed:
                            - { slot: "top_base", category: "tee_long", displayName: "長袖Tシャツ" }
                            - { slot: "outerwear", category: "hoodie", displayName: "薄手パーカー" }
                            - { slot: "bottom", category: "pants", displayName: "パンツ" }
                          notes: []
                      - name: "娘"
                        ageGroup: "toddler"
                        suggestion:
                          summary: "長袖＋羽織で体温調節"
                          layers: ["長袖Tシャツ", "カーディガン", "やわらかいパンツ"]
                          layersDetailed:
                            - { slot: "top_base", category: "tee_long", displayName: "長袖Tシャツ" }
                            - { slot: "midlayer", category: "cardigan", displayName: "カーディガン" }
                            - { slot: "bottom", category: "pants", displayName: "やわらかいパンツ" }
                          notes: []
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  value:
                    error: "Invalid request"
                    details:
                      userId:
                        - code: "required"
                          message: "Required path parameter"
        "404":
          description: User or data not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  value:
                    error: "Not Found"
        "500":
          description: Internal Server Error — 接続エラーや想定外のエラー時
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/weather/hourly/{userId}:
    get:
      summary: Get 3-hourly forecast (free plan)
      description: 無料版の前提で、ユーザーIDから地域を取得し3時間刻みの予報を返します。`limitHours` クエリで返却時間数を指定可能（3時間ステップで切り上げ）。
      tags: [Weather]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: limitHours
          in: query
          required: false
          description: 返却する時間数（3時間ステップで切り上げ）。許容範囲は1〜48。
          schema:
            type: integer
            minimum: 1
            maximum: 48
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HourlyWeatherResponse'
              examples:
                success:
                  value:
                    region: "東京"
                    intervalHours: 3
                    hourly:
                      - timestamp: 1735795200
                        temperatureCelsius: 6.2
                        feelsLikeCelsius: 4.9
                        humidity: 72
                        windSpeed: 2.1
                        condition: "cloudy"
                      - timestamp: 1735798800
                        temperatureCelsius: 6.0
                        feelsLikeCelsius: 4.7
                        humidity: 74
                        windSpeed: 2.0
                        condition: "cloudy"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  value:
                    error: "Invalid request"
                    details:
                      userId:
                        - code: "required"
                          message: "Required path parameter"
                      limitHours:
                        - code: "out_of_range"
                          message: "Must be between 1 and 48"
        "500":
          description: Internal Server Error — 接続エラーや想定外のエラー時
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'


components:
  schemas:
    TodayWeather:
      type: object
      required: [region, value, feelsLike, humidity, windSpeed, category, condition]
      properties:
        region:
          type: string
          description: 表示地域名
        value:
          type: number
          format: float
          description: 現在気温(°C)
        feelsLike:
          type: number
          format: float
          description: 体感温度(°C)
        humidity:
          type: integer
          description: 湿度(%)
        windSpeed:
          type: number
          format: float
          description: 風速(m/s)
        category:
          type: string
          description: 気温カテゴリ
          enum: [freezing, cold, cool, mild, warm, hot]
        condition:
          type: string
          description: 天気状態
          enum: [sunny, clear, cloudy, rain, drizzle, thunderstorm, snow, fog, mist, haze]
    TemperatureInfo:
      type: object
      required: [value, feelsLike, category]
      properties:
        value:
          type: number
          format: float
        feelsLike:
          type: number
          format: float
        category:
          type: string
          enum: [freezing, cold, cool, mild, warm, hot]
    SuggestionDetails:
      type: object
      required: [summary, layers]
      properties:
        summary:
          type: string
          description: 今日のひとこと（1〜2文）
          maxLength: 200
        layers:
          type: array
          items:
            type: string
        layersDetailed:
          type: array
          description: 服装レイヤーの詳細（任意）
          items:
            $ref: '#/components/schemas/LayerSpec'
        notes:
          type: array
          items:
            type: string
    LayerAttributes:
      type: object
      properties:
        warmthLevel:
          type: integer
          description: 1-5 の目安
        windproof:
          type: boolean
        waterproof:
          type: boolean
        breathability:
          type: integer
          description: 1-5 の目安
        materials:
          type: array
          items:
            type: string
        fit:
          type: string
          enum: [regular, loose, snug]
        kidSafe:
          type: boolean
    LayerSpec:
      type: object
      required: [slot, category, displayName]
      properties:
        slot:
          type: string
          enum: [top_base, midlayer, outerwear, bottom, legwear, footwear, headwear, handwear, accessory]
        category:
          type: string
          enum: [tee_short, tee_long, shirt, sweater, cardigan, hoodie, thermal, jacket_windproof, coat_down, coat_fleece, rain_jacket, pants, shorts, skirt, leggings, socks, hat, gloves, scarf, onesie]
        displayName:
          type: string
        attributes:
          $ref: '#/components/schemas/LayerAttributes'
    ClothesSuggestion:
      type: object
      required: [userId, ageGroup, temperature, suggestion]
      properties:
        userId:
          type: string
        ageGroup:
          type: string
          description: 年齢区分
          enum: [infant, toddler, child]
        temperature:
          $ref: '#/components/schemas/TemperatureInfo'
        suggestion:
          $ref: '#/components/schemas/SuggestionDetails'
    MemberClothesCard:
      type: object
      description: 本日の服装カード（タブ切替の各人物用）
      required: [name, ageGroup, suggestion]
      properties:
        name:
          type: string
          description: "表示名（例: たろう／パパ／娘）。プロフィールのnicknameやfamily.name。"
        ageGroup:
          type: string
          enum: [infant, toddler, child, teen, adult, senior]
        illustrationUrl:
          type: string
          format: uri
          description: 服装イラスト画像URL（未定の場合は省略）
        suggestion:
          $ref: '#/components/schemas/SuggestionDetails'
    HomeTodayResponse:
      type: object
      description: ホーム画面に必要な統合レスポンス
      required: [summary, weather, members]
      properties:
        summary:
          type: string
          description: 今日のひとこと（1〜2文）
          maxLength: 200
        weather:
          $ref: '#/components/schemas/TodayWeather'
        members:
          type: array
          description: 本日の服装カード一覧（ユーザー＋家族）
          items:
            $ref: '#/components/schemas/MemberClothesCard'
    HourlyWeatherItem:
      type: object
      required: [timestamp, temperatureCelsius, feelsLikeCelsius, humidity, windSpeed, condition]
      properties:
        timestamp:
          type: integer
          description: UNIX時刻（秒）
        temperatureCelsius:
          type: number
        feelsLikeCelsius:
          type: number
        humidity:
          type: integer
        windSpeed:
          type: number
        condition:
          type: string
          description: 天気説明
    HourlyWeatherResponse:
      type: object
      required: [region, intervalHours, hourly]
      properties:
        region:
          type: string
        intervalHours:
          type: integer
          description: 返却データの時間間隔（無料版は常に3）
          enum: [3]
        hourly:
          type: array
          items:
            $ref: '#/components/schemas/HourlyWeatherItem'
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: "エラーメッセージ（例: Internal Server Error）"
        details:
          type: object
          additionalProperties:
            type: array
            items:
              type: object
              properties:
                code:
                  type: string
                message:
                  type: string
